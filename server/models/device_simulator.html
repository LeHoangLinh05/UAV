<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GPS Simulator</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --warning-color: #f1c40f;
            --light-bg: #f4f6f9;
            --dark-text: #2c3e50;
            --light-text: #7f8c8d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 15px; background-color: var(--light-bg); color: var(--dark-text); }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: var(--dark-text); text-align: center; margin-top: 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 1rem; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); outline: none; }
        #toggleBtn { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; color: white; background-color: var(--primary-color); transition: background-color 0.3s, transform 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #toggleBtn:hover { background-color: #2980b9; }
        #toggleBtn:active { transform: scale(0.98); }
        #toggleBtn.active { background-color: var(--error-color); }
        #toggleBtn.active:hover { background-color: #c0392b; }
        .icon { font-size: 1.2em; }
        .status-card { margin-top: 20px; padding: 15px; border-radius: 8px; border-left: 5px solid; }
        .status-card.info { border-color: var(--primary-color); background-color: #eaf5ff; }
        .status-card.success { border-color: var(--success-color); background-color: #eafaf1; }
        .status-card.error { border-color: var(--error-color); background-color: #fdedec; }
        .log-container { margin-top: 20px; }
        #log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: 'Courier New', Courier, monospace; font-size: 0.9em; white-space: pre-wrap; word-wrap: break-word; }
        #log div { padding: 2px 0; border-bottom: 1px solid #34495e; }
        #log .log-error { color: #ff7675; }
        #log .log-success { color: #55efc4; }
        #log .log-info { color: #74b9ff; }
    </style>
</head>
<body>
<div class="container">
    <h1><span class="icon">üõ∞Ô∏è</span> GPS Simulator</h1>

    <div>
        <label for="deviceId">M√£ ƒë·ªãnh danh (S/N):</label>
        <input type="text" id="deviceId" placeholder="Nh·∫≠p S/N t·ª´ trang qu·∫£n l√Ω">
    </div>

    <button id="toggleBtn">
        <span class="icon">‚ñ∂Ô∏è</span>
        <span>B·∫Øt ƒë·∫ßu g·ª≠i GPS</span>
    </button>

    <div id="status-card" class="status-card info">
        <strong>Tr·∫°ng th√°i:</strong> <span>S·∫µn s√†ng.</span>
    </div>

    <div class="log-container">
        <label>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông:</label>
        <div id="log"></div>
    </div>
</div>

<script>
    const deviceIdInput = document.getElementById('deviceId');
    const statusCard = document.getElementById('status-card');
    const statusText = statusCard.querySelector('span');
    const logContainer = document.getElementById('log');
    const toggleBtn = document.getElementById('toggleBtn');
    const btnIcon = toggleBtn.querySelector('.icon');
    const btnText = toggleBtn.querySelector('span');

    // ‚ö†Ô∏è QUAN TR·ªåNG: Thay ƒë·ªïi URL n√†y th√†nh IP c·ªßa m√°y t√≠nh c·ªßa b·∫°n
    const SERVER_URL = 'http://192.168.0.104:5000';

    let watchId = null;

    function log(message, type = 'info') {
        const time = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-${type}`;
        logEntry.textContent = `[${time}] ${message}`;
        logContainer.prepend(logEntry); // Th√™m log m·ªõi l√™n ƒë·∫ßu
    }

    deviceIdInput.value = localStorage.getItem('lastDeviceId') || '';
    deviceIdInput.addEventListener('input', (e) => {
        localStorage.setItem('lastDeviceId', e.target.value);
    });

    async function sendLocation(position) {
        const currentDeviceId = deviceIdInput.value.trim();
        log(`L·∫•y ƒë∆∞·ª£c v·ªã tr√≠: Lat ${position.coords.latitude.toFixed(4)}, Lng ${position.coords.longitude.toFixed(4)}`);

        const locationData = {
            deviceId: currentDeviceId,
            lat: position.coords.latitude,
            lng: position.coords.longitude
        };

        try {
            log(`ƒêang g·ª≠i t·ªõi server...`);
            const res = await fetch(`${SERVER_URL}/api/devices/location`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(locationData)
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.error || `Server tr·∫£ v·ªÅ l·ªói ${res.status}`);

            log(`Server ph·∫£n h·ªìi: ${data.message}`, 'success');
            updateStatus('ƒê√£ g·ª≠i th√†nh c√¥ng!', 'success');

        } catch (error) {
            console.error('L·ªói khi g·ª≠i v·ªã tr√≠:', error);
            log(`L·ªói khi g·ª≠i request: ${error.message}`, 'error');
            updateStatus(`L·ªói k·∫øt n·ªëi.`, 'error');
            stopSending();
        }
    }

    function startSending() {
        log('N√∫t "B·∫Øt ƒë·∫ßu" ƒë∆∞·ª£c nh·∫•n.');
        if (!navigator.geolocation) {
            log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.', 'error');
            updateStatus('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS.', 'error');
            return;
        }
        const currentDeviceId = deviceIdInput.value.trim();
        if (!currentDeviceId) {
            log('M√£ ƒë·ªãnh danh tr·ªëng.', 'error');
            updateStatus('Vui l√≤ng nh·∫≠p M√£ ƒë·ªãnh danh.', 'error');
            return;
        }
        if (watchId) {
            log('ƒê√£ ƒëang ch·∫°y, b·ªè qua.');
            return;
        }

        log('Y√™u c·∫ßu quy·ªÅn truy c·∫≠p GPS...');
        updateStatus('ƒêang ch·ªù quy·ªÅn GPS...', 'info');

        const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };

        // D√πng getCurrentPosition ƒë·ªÉ ki·ªÉm tra quy·ªÅn m·ªôt l·∫ßn tr∆∞·ªõc
        navigator.geolocation.getCurrentPosition(
            (initialPosition) => {
                log('ƒê√£ c√≥ quy·ªÅn GPS. B·∫Øt ƒë·∫ßu theo d√µi...', 'success');
                watchId = navigator.geolocation.watchPosition(sendLocation, handleError, options);

                btnText.textContent = 'D·ª´ng g·ª≠i GPS';
                btnIcon.textContent = '‚èπÔ∏è';
                toggleBtn.classList.add('active');
                deviceIdInput.disabled = true;
                updateStatus('ƒêang g·ª≠i v·ªã tr√≠...', 'success');
                sendLocation(initialPosition); // G·ª≠i v·ªã tr√≠ ƒë·∫ßu ti√™n ngay l·∫≠p t·ª©c
            },
            (error) => {
                handleError(error); // G·ªçi h√†m x·ª≠ l√Ω l·ªói chung
            },
            options
        );
    }

    function stopSending() {
        log('N√∫t "D·ª´ng" ƒë∆∞·ª£c nh·∫•n ho·∫∑c c√≥ l·ªói.');
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        btnText.textContent = 'B·∫Øt ƒë·∫ßu g·ª≠i GPS';
        btnIcon.textContent = '‚ñ∂Ô∏è';
        toggleBtn.classList.remove('active');
        deviceIdInput.disabled = false;
        updateStatus('ƒê√£ d·ª´ng.', 'info');
    }

    function handleError(error) {
        let message = '';
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = "Ng∆∞·ªùi d√πng t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "Th√¥ng tin v·ªã tr√≠ kh√¥ng c√≥ s·∫µn.";
                break;
            case error.TIMEOUT:
                message = "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ h·∫øt h·∫°n.";
                break;
            default:
                message = "M·ªôt l·ªói kh√¥ng x√°c ƒë·ªãnh ƒë√£ x·∫£y ra.";
                break;
        }
        log(message, 'error');
        updateStatus(message, 'error');
        stopSending();
    }

    function updateStatus(message, type) {
        statusCard.className = `status-card ${type}`;
        statusText.textContent = message;
    }

    toggleBtn.addEventListener('click', () => {
        if (watchId) {
            stopSending();
        } else {
            startSending();
        }
    });

    log('Simulator ƒë√£ s·∫µn s√†ng.');
</script>
</body>
</html>